<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Casa Victor · Panel de Clientes Leandro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #0f1115;
      color: #ffffff;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }
    .wrap { max-width: 1100px; margin: auto; padding: 20px; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background: #191c24; padding: 16px; border-radius: 10px;
      margin-bottom: 20px; border: 1px solid #333;
    }
    .cv-brand { display: flex; align-items: center; gap: 10px; }
    .cv-logo img { width: 60px; height: 60px; border-radius: 50%; }
    h1 { margin: 0 0 10px; font-size: 1rem; letter-spacing: 0.15em; text-transform: uppercase; }
    .subtitulo { color: #ccc; margin-bottom: 18px; }
    .layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    @media(max-width:900px){ .layout { grid-template-columns: 1fr; } }
    .card { background: #181b22; padding: 16px; border-radius: 10px; border: 1px solid #333; }
    label { font-size: .8rem; text-transform: uppercase; letter-spacing: .08em; }
    input, select, button {
      width: 100%; padding: 8px; margin-top: 6px; border-radius: 6px;
      background: #020617; border: 1px solid #444; color: #fff;
    }
    button { background:#f5f5f5; color:#000; cursor:pointer; }
    table { width:100%; border-collapse: collapse; margin-top:14px; font-size:.85rem; }
    th,td { border-bottom:1px solid #333; padding: 8px; }
    th { background:#111827; text-transform: uppercase; font-size:.75rem; }
    .chip { display:inline-block; padding:4px 10px; border:1px solid #444; margin-right:6px; border-radius:20px; font-size:.7rem; }
    .alerta { color: #ff7777; font-size:.8rem; margin-top:6px; }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="cv-brand">
      <div class="cv-logo">
        <img src="casavictor-logo.png">
      </div>
      <div>
        <div style="font-size:1.2rem; text-transform:uppercase;">Casa Victor</div>
        <div style="font-size:.8rem; text-transform:uppercase; letter-spacing:.1em; color:#ccc;">
          Panel clientes corporativos
        </div>
      </div>
    </div>

    <div style="text-align:right; font-size:.8rem; color:#ccc;">
      Vendedor: <b>Leandro</b><br>
      Accesorios · Marroquinería · Calzado
    </div>
  </header>

  <h1>Resumen de compras por cliente</h1>
  <div class="subtitulo">
    Seleccioná el archivo CSV → buscá un cliente → analizá artículos, marcas, rubros, unidades y volumen $.
  </div>

  <div class="layout">
    <div>

      <div class="card">
        <label>1 · Seleccionar archivo CSV</label>
        <input type="file" id="fileInput" accept=".csv">
        <div style="font-size:.75rem; color:#aaa; margin-top:6px;">
          Debe ser un .CSV separado por punto y coma (;)
        </div>
      </div>

      <div class="card">
        <label>2 · Buscar cliente</label>
        <input type="text" id="clienteInput" disabled placeholder="Ej: GUTIERREZ CALISAYA, AYELEN">
        <datalist id="listaClientes"></datalist>
        <button id="btnBuscar" disabled>Buscar</button>
        <div id="mensajeBusqueda" class="alerta" style="display:none;"></div>
      </div>

      <div class="card">
        <label>3 · Filtros temporales</label><br><br>
        <label>Año</label>
        <select id="filtroAnio" disabled>
          <option value="todos">Todos</option>
        </select>

        <label>Mes</label>
        <select id="filtroMes" disabled>
          <option value="todos">Todos</option>
        </select>
      </div>

    </div>

    <!-- RESULTADOS -->
    <div>
      <div class="card" id="detalleClienteCard" style="display:none;">
        <h2 id="tituloCliente"></h2>
        <div id="chipsCliente"></div>
        <div id="resumenCliente" style="margin-top:10px;"></div>

        <table>
          <thead>
            <tr>
              <th>Cod.</th>
              <th>Artículo</th>
              <th>Marca</th>
              <th>Rubro</th>
              <th>Unidades</th>
              <th>Volumen $</th>
            </tr>
          </thead>
          <tbody id="tablaArticulos"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
let ventas = [];
let clientesUnicos = [];
let clienteActual = null;

const fileInput = document.getElementById("fileInput");
const clienteInput = document.getElementById("clienteInput");
const listaClientes = document.getElementById("listaClientes");
const btnBuscar = document.getElementById("btnBuscar");
const mensajeBusqueda = document.getElementById("mensajeBusqueda");
const filtroAnio = document.getElementById("filtroAnio");
const filtroMes = document.getElementById("filtroMes");

const detalleClienteCard = document.getElementById("detalleClienteCard");
const tituloCliente = document.getElementById("tituloCliente");
const chipsCliente = document.getElementById("chipsCliente");
const resumenCliente = document.getElementById("resumenCliente");
const tablaArticulosBody = document.getElementById("tablaArticulos");

fileInput.addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (evt) {
    procesarCSV(evt.target.result);
  };
  reader.readAsText(file, "UTF-8");
});

function procesarCSV(texto) {
  const lineas = texto.trim().split(/\r?\n/);
  if (lineas.length < 2) {
    alert("Archivo vacío");
    return;
  }

  const encabezados = lineas[0].split(";").map(h => normalizar(h));

  // Map flexible de columnas
  function col(...variantes) {
    let idx = encabezados.findIndex(e => variantes.includes(e));
    return idx;
  }

  const idxAño = col("año","anio","ano","year");
  const idxMes = col("mes","month");
  const idxCod = col("cod. artículo","cod articulo","codigo","código","sku");
  const idxArt = col("artículo","articulo","descripcion","descripción","producto");
  const idxMarca = col("marca");
  const idxRubro = col("rubro","categoria","categoría");
  const idxCliente = col("cliente","razon social","razón social");
  const idxUnidades = col("unidades","cantidad","cant");
  const idxVolumen = col("volumen $","volumen","importe","total");

  if ([idxAño,idxMes,idxCod,idxArt,idxMarca,idxRubro,idxCliente,idxUnidades,idxVolumen].includes(-1)) {
    alert("Los encabezados no coinciden con lo esperado.\n\nEncabezados detectados:\n" + encabezados.join(" | "));
    return;
  }

  ventas = [];
  clientesUnicos = [];
  clienteActual = null;

  for (let i=1; i<lineas.length; i++) {
    const cols = lineas[i].split(";");

    const fila = {
      año: cols[idxAño],
      mes: cols[idxMes],
      cod: cols[idxCod],
      art: cols[idxArt],
      marca: cols[idxMarca],
      rubro: cols[idxRubro],
      cliente: cols[idxCliente],
      unidades: parseFloat(cols[idxUnidades] || 0),
      volumen: parseFloat(cols[idxVolumen] || 0)
    };

    ventas.push(fila);

    if (!clientesUnicos.includes(fila.cliente)) clientesUnicos.push(fila.cliente);
  }

  cargarClientes();
  habilitarControles();
}

function normalizar(str) {
  return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

function cargarClientes() {
  listaClientes.innerHTML = "";
  clientesUnicos.sort().forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    listaClientes.appendChild(opt);
  });
}

function habilitarControles() {
  clienteInput.disabled = false;
  btnBuscar.disabled = false;
  filtroAño.disabled = false;
  filtroMes.disabled = false;
}

btnBuscar.addEventListener("click", buscarCliente);

function buscarCliente() {
  const texto = clienteInput.value.trim().toLowerCase();
  mensajeBusqueda.style.display="none";

  if (!texto) {
    mensajeBusqueda.textContent = "Ingresá un cliente.";
    mensajeBusqueda.style.display = "block";
    return;
  }

  const match = clientesUnicos.find(c => c.toLowerCase() === texto)
           || clientesUnicos.find(c => c.toLowerCase().includes(texto));

  if (!match) {
    mensajeBusqueda.textContent = "Cliente no encontrado.";
    mensajeBusqueda.style.display = "block";
    return;
  }

  clienteActual = match;
  mostrarCliente();
}

function mostrarCliente() {
  const datos = ventas.filter(v => v.cliente === clienteActual);

  tituloCliente.textContent = clienteActual;
  detalleClienteCard.style.display = "block";

  // resumen
  const totalU = datos.reduce((a,b)=>a+b.unidades,0);
  const totalV = datos.reduce((a,b)=>a+b.volumen,0);
  resumenCliente.innerHTML =
    `Unidades: <b>${totalU}</b><br>Volumen: <b>$ ${totalV.toLocaleString("es-AR")}</b>`;

  chipsCliente.innerHTML = "";
  const años = [...new Set(datos.map(d=>d.año))];
  const meses = [...new Set(datos.map(d=>d.mes))];
  chipsCliente.innerHTML =
    `<span class="chip">Años: ${años.join(", ")}</span>
     <span class="chip">Meses: ${meses.join(", ")}</span>`;

  tablaArticulosBody.innerHTML = "";
  datos.forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.cod}</td>
      <td>${d.art}</td>
      <td>${d.marca}</td>
      <td>${d.rubro}</td>
      <td>${d.unidades}</td>
      <td>$ ${d.volumen.toLocaleString("es-AR")}</td>
    `;
    tablaArticulosBody.appendChild(tr);
  });
}
</script>

</body>
</html>
